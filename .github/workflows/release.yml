name: release

on:
    workflow_dispatch:
        inputs:
            run-id:
                description: "Build workflow run ID"
                required: true
                type: string
            only-publish:
                description: "Only publish packages to"
                required: false
                type: choice
                default: All
                options:
                    - npmjs.com
                    - NuGet.org
                    - PyPI.org
                    - MirrorChyan
                    - All
            dry-run:
                description: "Use dry-run"
                required: false
                type: boolean
                default: false
            run-name:
                description: "Run name"
                required: false
                type: string

run-name: ${{ inputs.run-name }}
concurrency:
    group: ${{ github.workflow }}-${{ inputs.run-id }}
    cancel-in-progress: false

jobs:
    meta:
        uses: ./.github/workflows/meta.yml
        with:
            reuse-from-run-id: ${{ inputs.run-id }}

    nuget:
        if: ${{ inputs.only-publish == 'NuGet.org' || inputs.only-publish == 'All' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        outputs:
            result: ${{ steps.publish.outcome }}
        permissions:
            id-token: write
        env:
            NUGET_PACKAGE_SOURCE: ${{ inputs.dry-run && 'https://apiint.nugettest.org/v3/index.json' || 'https://api.nuget.org/v3/index.json' }}
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-nuget
                  path: assets/pkgs-nuget
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Publish NuGet
              id: publish
              run: |
                  dotnet nuget push assets/pkgs-nuget/*.nupkg \
                    --source $NUGET_PACKAGE_SOURCE \
                    --skip-duplicate

    pip:
        if: ${{ inputs.only-publish == 'PyPI.org' || inputs.only-publish == 'All' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        outputs:
            result: ${{ steps.publish.outcome }}
        permissions:
            id-token: write
        env:
            PYPI_REPOSITORY_URL: ${{ inputs.dry-run && 'https://test.pypi.org/legacy/' || 'https://upload.pypi.org/legacy/' }}
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-pip
                  path: assets/pkgs-pip
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Publish Pip Packages
              id: publish
              run: |
                  pip install --upgrade twine packaging
                  python -m twine upload \
                    assets/pkgs-pip/*.whl \
                    --repository-url $PYPI_REPOSITORY_URL \
                    --username __token__ \
                    --password ${{ secrets.PYPI_TOKEN }} \
                    --skip-existing

    nodejs:
        if: ${{ inputs.only-publish == 'npmjs.com' || inputs.only-publish == 'All' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        outputs:
            result: ${{ steps.publish.outcome }}
        permissions:
            id-token: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-nodejs
                  path: assets/pkgs-nodejs
                  check_artifacts: true
                  if_no_artifact_found: fail

            - uses: ./.github/actions/publish_nodejs
              id: publish
              with:
                  access: public
                  path: assets/pkgs-nodejs
                  dry-run: ${{ inputs.dry-run }}

    mirrorchyan:
        needs: meta
        if: ${{ inputs.only-publish == 'MirrorChyan' || inputs.only-publish == 'All' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        outputs:
            result: ${{ steps.publish.outcome }}
        steps:
            - name: Trigger MirrorChyanUploading
              id: publish
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [ "${{ inputs.dry-run }}" = "true" ]; then
                    echo "Dry run mode, skipping MirrorChyan upload."
                    exit 0
                  fi

                  gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan.yml -f tag=${{ needs.meta.outputs.tag }}
                  gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan_release_note.yml -f tag=${{ needs.meta.outputs.tag }}

    github:
        needs: [meta, nuget, pip, nodejs, mirrorchyan]
        runs-on: ubuntu-latest
        continue-on-error: true
        outputs:
            result: ${{ steps.publish.outcome }}
        permissions:
            contents: write
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: MAA-*
                  path: assets
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Package artifacts
              run: |
                  cd assets
                  for f in *; do
                    (cd $f && zip -r ../$f-${{ needs.meta.outputs.tag }}.zip .)
                  done

            - id: publish
              uses: softprops/action-gh-release@v2
              with:
                  files: assets/*.zip
                  tag_name: ${{ inputs.dry-run && 'v0.0.0' || needs.meta.outputs.tag }}
                  prerelease: ${{ needs.meta.outputs.is-prerelease == 'true' }}
                  generate_release_notes: true

    create_issue_on_failure:
        needs: [meta, nuget, pip, nodejs, mirrorchyan, github]
        runs-on: ubuntu-latest
        if: always() && (
                needs.nuget.outputs.result != 'success' ||
                needs.pip.outputs.result != 'success' ||
                needs.nodejs.outputs.result != 'success' ||
                needs.mirrorchyan.outputs.result != 'success' ||
                needs.github.outputs.result != 'success'
            )
        env:
            ISSUE_TITLE: "${{ needs.meta.outputs.tag }} failed to release"
            ISSUE_BODY: |
                A new release attempt for tag ${{ needs.meta.outputs.tag }} failed.
                
                ${{ needs.nuget.outputs.result != 'success' && '- nuget @moomiji' || '' }}
                ${{ needs.pip.outputs.result != 'success' && '- pip @MistEO' || '' }}
                ${{ needs.nodejs.outputs.result != 'success' && '- nodejs @neko-para' || '' }}
                ${{ needs.mirrorchyan.outputs.result != 'success' && '- mirrorchyan @MistEO' || '' }}
                
                Release run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                Build   run: [${{ inputs.run-id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.run-id }})
                
                | Job | Result |
                | --- | ------ |
                | nuget | ${{ needs.nuget.outputs.result }} |
                | pip | ${{ needs.pip.outputs.result }} |
                | nodejs | ${{ needs.nodejs.outputs.result }} |
                | mirrorchyan | ${{ needs.mirrorchyan.outputs.result }} |
                | github | ${{ needs.github.outputs.result }} |

                cc @MistEO
        steps:
            - name: find issues
              id: find-issues
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "find-issues"
                  issue-state: "all"
                  title-includes: "${{ env.ISSUE_TITLE }}"
            - name: Create issue
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0] == null }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "create-issue"
                  title: ${{ env.ISSUE_TITLE }}
                  body: ${{ env.ISSUE_BODY }}
            - name: Open issue
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0].state == 'closed' }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "open-issue"
                  issue-number: ${{ fromJSON(steps.find-issues.outputs.issues)[0].number }}
            - name: Add comment
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0] != null }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "create-comment"
                  issue-number: ${{ fromJSON(steps.find-issues.outputs.issues)[0].number }}
                  body: ${{ env.ISSUE_BODY }}
