name: release

on:
    workflow_dispatch:
        inputs:
            run-id:
                description: "Build workflow run ID to use for artifacts"
                required: true
                type: string
            only-publish:
                description: Only publish packages to the chosen package repository
                required: false
                type: choice
                options:
                    - npmjs.com
                    - NuGet.org
                    - PyPI.org
                    - mirrorchyan
            dry-run:
                description: Avoid actually publishing anything.
                required: false
                type: boolean
                default: false

concurrency:
    group: ${{ github.workflow }}-${{ inputs.run-id }}
    cancel-in-progress: false

permissions:
    contents: write
    actions: read
    issues: write
    id-token: write # required to use OIDC

jobs:
    meta:
        uses: ./.github/workflows/meta.yml
        with:
            reuse-from-run-id: ${{ inputs.run-id }}

    nuget:
        if: ${{ inputs.only-publish == 'NuGet.org' || inputs.only-publish == '' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        env:
            NUGET_PACKAGE_SOURCE: https://api.nuget.org/v3/index.json
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-nuget
                  path: assets/pkgs-nuget
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Publish NuGet
              id: publish
              run: |
                  dotnet nuget push assets/pkgs-nuget/*.nupkg \
                    --api-key ${{ secrets.NuGetAPIKey }} \
                    --source $NUGET_PACKAGE_SOURCE \
                    --skip-duplicate

    pip:
        if: ${{ inputs.only-publish == 'PyPI.org' || inputs.only-publish == '' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-pip
                  path: assets/pkgs-pip
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Publish Pip Packages
              id: publish
              run: |
                  pip install --upgrade twine packaging
                  python -m twine upload \
                    assets/pkgs-pip/*.whl \
                    --username __token__ \
                    --password ${{ secrets.PYPI_TOKEN }} \
                    --skip-existing

    nodejs:
        if: ${{ inputs.only-publish == 'npmjs.com' || inputs.only-publish == '' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: pkgs-nodejs
                  path: assets/pkgs-nodejs
                  check_artifacts: true
                  if_no_artifact_found: fail

            - uses: MaaXYZ/MaaFramework/.github/actions/publish_nodejs@main
              id: publish
              with:
                  access: public
                  path: assets/pkgs-nodejs

    mirrorchyan:
        needs: meta
        if: ${{ inputs.only-publish == 'mirrorchyan' || inputs.only-publish == '' }}
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:
            - name: Trigger MirrorChyanUploading
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan.yml -f tag=${{ needs.meta.outputs.tag }}
                  gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan_release_note.yml -f tag=${{ needs.meta.outputs.tag }}

    release:
        needs: [meta, nuget, pip, nodejs, mirrorchyan]
        runs-on: ubuntu-latest
        steps:
            - uses: dawidd6/action-download-artifact@v6
              with:
                  workflow: build.yml
                  run_id: ${{ inputs.run-id }}
                  name: MAA-*
                  path: assets
                  check_artifacts: true
                  if_no_artifact_found: fail

            - name: Package artifacts
              run: |
                  cd assets
                  for f in *; do
                    (cd $f && zip -r ../$f-${{ needs.meta.outputs.tag }}.zip .)
                  done

            - uses: softprops/action-gh-release@v2
              with:
                  files: assets/*.zip
                  tag_name: ${{ needs.meta.outputs.tag }}
                  prerelease: ${{ needs.meta.outputs.is-prerelease == 'true' }}
                  generate_release_notes: true

    create_issue_on_failure:
        needs: [meta, nuget, pip, nodejs, mirrorchyan, release]
        runs-on: ubuntu-latest
        if: always() && (
                needs.nuget.result == 'failure' ||
                needs.pip.result == 'failure' ||
                needs.nodejs.result == 'failure' ||
                needs.mirrorchyan.result == 'failure' ||
                needs.release.result == 'failure'
            )
        env:
            ISSUE_TITLE: "${{ needs.meta.outputs.tag }} failed to release"
            ISSUE_BODY: |
                A new release attempt for tag ${{ needs.meta.outputs.tag }} failed. Please check and retry publishing the packages listed below if needed:
                ${{ needs.nuget.result == 'failure' && '- nuget @moomiji' || '' }}
                ${{ needs.pip.result == 'failure' && '- pip @MistEO' || '' }}
                ${{ needs.nodejs.result == 'failure' && '- nodejs @neko-para' || '' }}
                ${{ needs.mirrorchyan.result == 'failure' && '- mirrorchyan @MistEO' || '' }}
                
                Release run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                Build run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.run-id }}
                Job results:
                - nuget: ${{ needs.nuget.result }}
                - pip: ${{ needs.pip.result }}
                - nodejs: ${{ needs.nodejs.result }}
                - mirrorchyan: ${{ needs.mirrorchyan.result }}
                - release: ${{ needs.release.result }}

                cc @MistEO
        steps:
            - name: find issues
              id: find-issues
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "find-issues"
                  issue-state: "all"
                  title-includes: "${{ env.ISSUE_TITLE }}"
            - name: Create issue
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0] == null }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "create-issue"
                  title: ${{ env.ISSUE_TITLE }}
                  body: ${{ env.ISSUE_BODY }}
            - name: Open issue
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0].state == 'closed' }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "open-issue"
                  issue-number: ${{ fromJSON(steps.find-issues.outputs.issues)[0].number }}
            - name: Add comment to existing issue
              if: ${{ fromJSON(steps.find-issues.outputs.issues)[0] != null }}
              uses: actions-cool/issues-helper@v3
              with:
                  actions: "create-comment"
                  issue-number: ${{ fromJSON(steps.find-issues.outputs.issues)[0].number }}
                  body: ${{ env.ISSUE_BODY }}

