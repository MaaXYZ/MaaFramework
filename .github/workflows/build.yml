name: build

on:
    push:
        tags:
            - "v*"
        branches:
            - "**"
        paths:
            - ".github/workflows/build.yml"
            - "3rdparty/**"
            - "cmake/**"
            - "include/**"
            - "source/**"
            - "CMakeLists.txt"
            - "tools/pip_pack/**"

    pull_request:
        branches:
            - "**"
        paths:
            - ".github/workflows/build.yml"
            - "3rdparty/**"
            - "cmake/**"
            - "include/**"
            - "source/**"
            - "CMakeLists.txt"
            - "tools/pip_pack/**"

    workflow_dispatch:
        inputs:
            build-config:
                required: true
                default: "RelWithDebInfo"
                type: choice
                options:
                    - Debug
                    - RelWithDebInfo
                    - Release

    repository_dispatch:
        types: [MaaUtilsUpdated]

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.head.repo.full_name || github.repository }}-${{ github.head_ref || github.ref_name }}${{ github.ref == 'refs/heads/dev' && format('-{0}', github.sha) || '' }}
    cancel-in-progress: true

jobs:
    meta:
        uses: ./.github/workflows/meta.yml
        with:
            build-config: ${{ inputs.build-config || 'RelWithDebInfo' }}


    windows:
        needs: meta
        runs-on: windows-latest
        strategy:
            matrix:
                arch: [x86_64, aarch64]
            fail-fast: false

        steps:
            - name: Windows runner hack
              shell: cmd
              run: |
                  dir d:\a
                  cd ..
                  mkdir C:\MaaFramework
                  rmdir MaaFramework
                  mklink /j MaaFramework C:\MaaFramework
                  dism /Online /Disable-Feature /FeatureName:Windows-Defender /Remove /NoRestart /Quiet
                  cd .

            - name: Windows runner hack (2)
              uses: al-cheb/configure-pagefile-action@v1.4
              with:
                  minimum-size: 16GB
                  maximum-size: 16GB
                  disk-root: "D:"

            - uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Update MaaUtils
              if: github.event_name == 'repository_dispatch' && github.event.action == 'MaaUtilsUpdated'
              run: |
                  git submodule update --remote source/MaaUtils

            - name: Setup Windows 10 SDK
              uses: GuillaumeFalourd/setup-windows10-sdk-action@v2.2
              with:
                  sdk-version: 26100

            - name: Cache MaaDeps
              id: cache-maadeps
              uses: actions/cache@v4
              with:
                  path: |
                      ./source/MaaUtils/MaaDeps
                  key: maadeps-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('./tools/maadeps-download.py') }}

            - name: Bootstrap MaaDeps
              if: steps.cache-maadeps.outputs.cache-hit != 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python3 tools/maadeps-download.py ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-windows

            - uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: Use Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Prepare node_modules
              run: |
                  cd source/binding/NodeJS
                  pnpm i
                  cd -

            - name: Build MAA
              run: |
                  cmake --preset "${{ matrix.arch == 'x86_64' && 'MSVC 2022' || 'MSVC 2022 ARM' }}" -DCMAKE_SYSTEM_VERSION="10.0.26100.0" -DMAADEPS_TRIPLET="maa-${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-windows" -DMAA_HASH_VERSION='${{ needs.meta.outputs.tag }}' -DWITH_NODEJS_BINDING=ON -DWITH_QUICKJS_BINDING=ON

                  cmake --build build --preset "${{ matrix.arch == 'x86_64' && 'MSVC 2022' || 'MSVC 2022 ARM' }} - ${{ needs.meta.outputs.build-config }}" -j 16

            - name: Install
              shell: bash
              run: |
                  cmake --install build --prefix install --config ${{ needs.meta.outputs.build-config }}
                  rm -rf install/bin/msvc-debug

                  cp -r docs install
                  cp README*.md install

                  cp -r sample install

                  cp -r LICENSE.md install

            - name: Download Plugin
              uses: robinraju/release-downloader@v1
              with:
                  repository: MaaXYZ/MaaPluginDemo
                  tag: ${{ needs.meta.outputs.latest-plugin }}
                  fileName: "*win-${{ matrix.arch }}*"
                  out-file-path: "build/download_plugins"
                  extract: true
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Plugin
              shell: bash
              run: |
                  cp -r build/download_plugins/bin install/bin/plugins

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: MAA-win-${{ matrix.arch }}
                  path: "install"

    ubuntu:
        needs: meta
        runs-on: ubuntu-latest
        strategy:
            matrix:
                arch: [aarch64, x86_64]
            fail-fast: false

        steps:
            - name: Install dep
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y ninja-build cmake ccache

            - uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: Use Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            # https://github.com/MaaXYZ/MaaFramework/actions/runs/5643408179/job/15285186255
            - uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Update MaaUtils
              if: github.event_name == 'repository_dispatch' && github.event.action == 'MaaUtilsUpdated'
              run: |
                  git submodule update --remote source/MaaUtils

            - name: Setup ccache
              uses: Chocobo1/setup-ccache-action@v1
              with:
                  remove_stale_cache: false

            - name: Bootstrap MaaDeps
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python3 tools/maadeps-download.py ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-linux

            - name: Prepare node_modules
              run: |
                  cd source/binding/NodeJS
                  pnpm i
                  cd -

            - name: Build MAA
              run: |
                  cmake --preset 'NinjaMulti Linux ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}' \
                    -DMAADEPS_TRIPLET='maa-${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-linux' \
                    -DMAA_HASH_VERSION='${{ needs.meta.outputs.tag }}' \
                    -DWITH_NODEJS_BINDING=ON -DWITH_QUICKJS_BINDING=ON

                  cmake --build build --preset 'NinjaMulti Linux ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }} - ${{ needs.meta.outputs.build-config }}' -j 16

            - name: Install
              shell: bash
              run: |
                  cmake --install build --prefix install --config ${{ needs.meta.outputs.build-config }}

                  if [[ ${{ needs.meta.outputs.build-config }} == RelWithDebInfo ]]; then
                    tools/split-linux-debug.sh install
                  fi

                  cp -r docs install
                  cp README*.md install

                  cp -r sample install

                  cp -r LICENSE.md install

            - name: Download Plugin
              uses: robinraju/release-downloader@v1
              with:
                  repository: MaaXYZ/MaaPluginDemo
                  tag: ${{ needs.meta.outputs.latest-plugin }}
                  fileName: "*linux-${{ matrix.arch }}*"
                  out-file-path: "build/download_plugins"
                  extract: true
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Plugin
              shell: bash
              run: |
                  cp -r build/download_plugins/bin install/bin/plugins

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: MAA-linux-${{ matrix.arch }}
                  path: "install"

    macos:
        needs: meta
        strategy:
            matrix:
                arch: [aarch64, x86_64]
            fail-fast: false
        runs-on: macos-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Update MaaUtils
              if: github.event_name == 'repository_dispatch' && github.event.action == 'MaaUtilsUpdated'
              run: |
                  git submodule update --remote source/MaaUtils

            - uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: 16.2

            - name: Install dep
              run: |
                  brew install ninja ccache

            - name: Setup ccache
              uses: Chocobo1/setup-ccache-action@v1
              with:
                  remove_stale_cache: false

            - name: Bootstrap MaaDeps
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python3 tools/maadeps-download.py ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-osx

            - uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: Use Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Prepare node_modules
              run: |
                  cd source/binding/NodeJS
                  pnpm i
                  cd -

            - name: Build MAA
              run: |
                  cmake --preset 'NinjaMulti' \
                    -DMAADEPS_TRIPLET='maa-${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-osx' \
                    -DMAA_HASH_VERSION='${{ needs.meta.outputs.tag }}' \
                    -DCMAKE_OSX_SYSROOT=macosx \
                    -DWITH_NODEJS_BINDING=ON -DWITH_QUICKJS_BINDING=ON \
                    -DCMAKE_OSX_ARCHITECTURES='${{ matrix.arch == 'x86_64' && 'x86_64' || 'arm64' }}'

                  cmake --build build --preset 'NinjaMulti - ${{ needs.meta.outputs.build-config }}' -j 16

            - name: Install
              shell: bash
              run: |
                  cmake --install build --prefix install --config ${{ needs.meta.outputs.build-config }}

                  if [[ ${{ needs.meta.outputs.build-config }} == RelWithDebInfo ]]; then
                    tools/collect-mac-debug.sh install
                  fi

                  cp -r docs install
                  cp README*.md install

                  cp -r sample install

                  cp -r LICENSE.md install

            - name: Download Plugin
              uses: robinraju/release-downloader@v1
              with:
                  repository: MaaXYZ/MaaPluginDemo
                  tag: ${{ needs.meta.outputs.latest-plugin }}
                  fileName: "*macos-${{ matrix.arch }}*"
                  out-file-path: "build/download_plugins"
                  extract: true
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Plugin
              shell: bash
              run: |
                  cp -r build/download_plugins/bin install/bin/plugins

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: MAA-macos-${{ matrix.arch }}
                  path: "install"

    android:
        needs: meta
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - arch: x86_64
                    - arch: aarch64
            fail-fast: false

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Update MaaUtils
              if: github.event_name == 'repository_dispatch' && github.event.action == 'MaaUtilsUpdated'
              run: |
                  git submodule update --remote source/MaaUtils

            - name: Install dep
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y ninja-build cmake ccache

            - uses: nttld/setup-ndk@v1
              id: setup-ndk
              with:
                  ndk-version: r27c

            - name: Setup ccache
              uses: Chocobo1/setup-ccache-action@v1
              with:
                  remove_stale_cache: false

            - name: Bootstrap MaaDeps
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python3 tools/maadeps-download.py ${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-android

            - name: Build MAA
              run: |
                  cmake --preset 'NinjaMulti' \
                    -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path}}/build/cmake/android.toolchain.cmake \
                    -DANDROID_ABI=${{ matrix.arch == 'x86_64' && 'x86_64' || 'arm64-v8a' }} \
                    -DANDROID_PLATFORM=android-23 \
                    -DMAADEPS_TRIPLET='maa-${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}-android' \
                    -DMAA_HASH_VERSION='${{ needs.meta.outputs.tag }}'

                  cmake --build build --preset 'NinjaMulti - ${{ needs.meta.outputs.build-config }}' -j 16

            - name: Install
              shell: bash
              run: |
                  cmake --install build --prefix install --config ${{ needs.meta.outputs.build-config }}

                  cp -r docs install
                  cp README*.md install

                  cp -r sample install

                  cp -r LICENSE.md install

            - name: Download Plugin
              uses: robinraju/release-downloader@v1
              with:
                  repository: MaaXYZ/MaaPluginDemo
                  tag: ${{ needs.meta.outputs.latest-plugin }}
                  fileName: "*android-${{ matrix.arch }}*"
                  out-file-path: "build/download_plugins"
                  extract: true
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Plugin
              shell: bash
              run: |
                  cp -r build/download_plugins/bin install/bin/plugins

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: MAA-android-${{ matrix.arch }}
                  path: "install"

    nuget_pack:
        needs: [meta, windows, ubuntu, macos, android]
        runs-on: windows-latest
        steps:
            - uses: nuget/setup-nuget@v2

            - uses: actions/checkout@v4
            - uses: actions/download-artifact@v4
              with:
                  path: assets

            - name: Nuget Pack
              working-directory: tools/nupkgs
              shell: bash
              run: ./pack.sh ${{ needs.meta.outputs.version }}

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: pkgs-nuget
                  path: "tools/nupkgs/*.nupkg"

    pip_pack:
        needs: [meta, windows, ubuntu, macos, android]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/download-artifact@v4
              with:
                  path: assets

            - name: Pip Pack
              run: |
                  tag=${{ needs.meta.outputs.tag }}
                  pip install --upgrade -r tools/pip_pack/requirements.txt
                  python tools/pip_pack/pip_pack.py $tag

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: pkgs-pip
                  path: "pip_pack/wheel/*.whl"

    nodejs_pack:
        needs: [meta, windows, ubuntu, macos, android]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/download-artifact@v4
              with:
                  path: assets

            - uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: Use Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Build wrapper
              run: |
                  cd source/binding/NodeJS
                  mkdir -p release/maa-node/dist
                  cp src/apis/*.d.ts release/maa-node/dist
                  cp release/maa-node/src/*.js release/maa-node/dist

            - name: Package wrapper
              run: |
                  ASSETS=`pwd`/assets

                  cd source/binding/NodeJS
                  pnpm i
                  npx tsx scripts/pack.ts $ASSETS ${{ needs.meta.outputs.tag }}

            - uses: actions/upload-artifact@v4
              with:
                  name: pkgs-nodejs
                  path: "source/binding/NodeJS/release"

    update_submodule:
        if: ${{ github.event_name == 'repository_dispatch' && github.event.action == 'MaaUtilsUpdated' }}
        needs:
            [
                meta,
                windows,
                ubuntu,
                macos,
                android,
                nuget_pack,
                pip_pack,
                nodejs_pack,
            ]
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  submodules: true

            - name: Update submodules
              run: |
                  git submodule update --remote source/MaaUtils

            - name: Commit and push changes
              uses: actions-js/push@master
              with:
                  rebase: true
                  branch: ${{ github.ref }}
                  message: "chore: Update Submodule MaaUtils

                      https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

                      [skip changelog]"
                  github_token: ${{ secrets.GITHUB_TOKEN }}

    trigger_release:
        if: ${{ needs.meta.outputs.is-release == 'true' && github.repository_id == '632024122' }}
        needs:
            [
                meta,
                windows,
                ubuntu,
                macos,
                android,
                nuget_pack,
                pip_pack,
                nodejs_pack,
            ]
        runs-on: ubuntu-latest
        steps:
            - name: Trigger release workflow
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh workflow run --repo $GITHUB_REPOSITORY release.yml \
                    -f run-id="${{ github.run_id }}" \
                    -f run-name="${{ needs.meta.outputs.tag }}" \
