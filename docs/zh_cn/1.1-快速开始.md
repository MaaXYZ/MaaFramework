# å¿«é€Ÿå¼€å§‹

## å¼€å‘æ€è·¯

MaaFramework æ”¯æŒå®Œå…¨é€šè¿‡ Json ä½ä»£ç ç¼–ç¨‹ï¼ˆPipeline Jsonï¼‰ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº† [æ¥å£](2.1-é›†æˆæ–‡æ¡£.md) ä»¥ä¾›å¼€å‘è€…è‡ªè¡Œé›†æˆã€‚  
äº¦å¯å°†ä¸¤è€…ç»“åˆï¼Œå°†ä½ä»£ç ä½œä¸ºä¸€ç§ â€œå°è£…â€ è¿›è¡Œè°ƒç”¨ã€‚  
ä¸‹é¢ä»‹ç»å‡ ç§å¸¸ç”¨çš„é›†æˆæ–¹å¼ï¼š

### å®Œå…¨ä¾èµ– Json ä½ä»£ç ç¼–ç¨‹ï¼ˆä½¿ç”¨ MaaPiCli.exeï¼‰

ç®€å•å¿«æ·ï¼Œä½†ä¸å¤Ÿçµæ´»ï¼Œæ¨è MaaFramework åˆå­¦è€…åŠç¼–ç¨‹å°ç™½ä½¿ç”¨ã€‚  
æˆ‘ä»¬ä¸ºæ­¤æ–¹å¼æä¾›äº† [ğŸï¸è§†é¢‘æ•™ç¨‹](https://www.bilibili.com/video/BV1yr421E7MW) å’Œ [â­é¡¹ç›®æ¨¡æ¿](https://github.com/MaaXYZ/MaaPracticeBoilerplate)ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```jsonc
// Json ä¸æ”¯æŒæ³¨é‡Šï¼Œæ­¤å¤„ä¸ºä¼ªä»£ç ï¼Œä»…ä¾›å‚è€ƒæ€è·¯ï¼Œæ— æ³•ç›´æ¥è¿è¡Œ
{
    "è¯†åˆ«å¹¶ç‚¹å‡»å¼€å§‹æŒ‰é’®": {
        "recognition": "OCR",           // æ–‡å­—è¯†åˆ«
        "expected": "å¼€å§‹",             // è¦è¯†åˆ«çš„å­—
        "action": "Click",              // åŠ¨ä½œï¼šç‚¹å‡»
        "next": [
            "è¯†åˆ«å¹¶ç‚¹å‡»ç¡®å®šå›¾æ ‡",
        ]
    },
    "è¯†åˆ«å¹¶ç‚¹å‡»ç¡®è®¤å›¾æ ‡": {
        "recognition": "TemplateMatch", // å›¾ç‰‡æ¨¡æ¿åŒ¹é…
        "template": "ç¡®è®¤.png",         // å›¾ç‰‡æ–‡ä»¶å
        "action": "Click"
    }
}
```

### ä½¿ç”¨ Json ä½ä»£ç ç¼–ç¨‹ï¼Œä½†å¯¹å¤æ‚ä»»åŠ¡ä½¿ç”¨è‡ªå®šä¹‰é€»è¾‘

**ğŸ’¡ MaaFW 4.x ç‰ˆæœ¬äº®ç‚¹åŠŸèƒ½**

ä½¿ç”¨é€šç”¨ GUI æˆ– CLI è¿è¡Œ MaaFW æœ¬ä½“ï¼ŒåŒæ—¶åœ¨å­è¿›ç¨‹ï¼ˆAgentServerï¼‰ä¸­æ³¨å†Œè‡ªå®šä¹‰ä»»åŠ¡ã€‚  
å½“é€šç”¨ GUI / CLI æ‰§è¡Œåˆ° `MyReco`/`MyAct` æ—¶ï¼Œä¼šè‡ªåŠ¨è¿æ¥æ‚¨çš„ AgentServer å­è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„è¯†åˆ«/åŠ¨ä½œã€‚  
è¯¥æ–¹æ³•å¯ä» 1 ä¸­æ— ç¼åˆ‡æ¢ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```jsonc
{
    "è¯†åˆ«å¹¶ç‚¹å‡»ç¡®è®¤å›¾æ ‡": {
        "next": [
            "æˆ‘çš„è‡ªå®šä¹‰ä»»åŠ¡"
        ]
    },
    "æˆ‘çš„è‡ªå®šä¹‰ä»»åŠ¡": {
        "recognition": "Custom",
        "custom_recognition": "MyReco",
        "action": "Custom",
        "custom_action": "MyAct"
    }
}
```

```python
# æ­¤å¤„ä¸ºä¼ªä»£ç ï¼Œä»…ä¾›å‚è€ƒæ€è·¯ï¼Œæ— æ³•ç›´æ¥è¿è¡Œ
from maa.agent.agent_server import AgentServer

def main():
    # å¯åŠ¨ AgentServer
    AgentServer.start_up("114514")
    AgentServer.join()
    AgentServer.shut_down()


# æ³¨å†Œè‡ªå®šä¹‰è¯†åˆ«å™¨
@AgentServer.custom_recognition("MyReco")
class MyRecognition(CustomRecognition):
    def analyze(context, ...):
        # è·å–å›¾ç‰‡ï¼Œç„¶åè¿›è¡Œè‡ªå·±çš„å›¾åƒæ“ä½œ
        image = context.tasker.controller.cached_image
        # è¿”å›å›¾åƒåˆ†æç»“æœ
        return AnalyzeResult(box=(10, 10, 100, 100))


# æ³¨å†Œè‡ªå®šä¹‰åŠ¨ä½œ
@AgentServer.custom_action("MyAct")
class MyAction(CustomAction):
    def run(context, ...):
        # è¿›è¡Œç‚¹å‡»
        context.controller.post_click(100, 10).wait()
        # é‡å†™æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ä»»åŠ¡
        context.override_next(node_name, ["TaskA", "TaskB"])

        return True
```

è¯¦æƒ…å¯å‚è€ƒ [æ¨¡æ¿ Commit](https://github.com/MaaXYZ/MaaPracticeBoilerplate/commit/126a56cefc17bf6c8335c703387d8d3ee2dad4d1)ã€‚

### è‡ªè¡Œç¼–å†™ä»£ç 

å¯ä»¥å°†ä½ä»£ç ä½œä¸ºä¸€ç§â€œå°è£…â€è¿›è¡Œè°ƒç”¨ï¼Œäº¦å¯æ³¨å†Œè‡ªå®šä¹‰å›è°ƒä½¿ç”¨

```python
# æ­¤å¤„ä¸ºä¼ªä»£ç ï¼Œä»…ä¾›å‚è€ƒæ€è·¯ï¼Œæ— æ³•ç›´æ¥è¿è¡Œ
# "è¯†åˆ«å¹¶ç‚¹å‡»å¼€å§‹æŒ‰é’®", "è¯†åˆ«å¹¶ç‚¹å‡»ç¡®è®¤å›¾æ ‡" ç­‰å‡ä¸º Json ä¸­çš„é€»è¾‘
def main():
    detail = tasker.post_task("è¯†åˆ«å¹¶ç‚¹å‡»å¼€å§‹æŒ‰é’®").wait().get()

    if detail.completed:
        tasker.controller.post_click(100, 100).wait()

    else:
        image = tasker.controller.cached_image
        save_to_file(image)

        tasker.resource.register_custom_action("MyAction", MyAction())
        tasker.post_task("è¯†åˆ«å¹¶ç‚¹å‡»ç¡®è®¤å›¾æ ‡").wait()

    image: np.ndarray = tasker.controller.post_screencap().wait().get()
```

## å‡†å¤‡èµ„æºæ–‡ä»¶

*â­è‹¥æ‚¨ä½¿ç”¨é¡¹ç›®æ¨¡æ¿ï¼Œç›´æ¥åœ¨ [æ–‡ä»¶å¤¹](https://github.com/MaaXYZ/MaaPracticeBoilerplate/tree/main/assets/resource) ä¸­ä¿®æ”¹å³å¯ã€‚*

æ‚¨éœ€è¦å‡†å¤‡ä¸€äº›èµ„æºæ–‡ä»¶ï¼Œ[å…¸å‹çš„æ–‡ä»¶ç»“æ„](https://github.com/MaaXYZ/MaaFramework/blob/main/sample/resource) å¦‚ä¸‹ï¼š

```tree
my_resource
â”œâ”€â”€ image
â”‚   â”œâ”€â”€ my_image_1.png
â”‚   â””â”€â”€ my_image_2.png
â”œâ”€â”€ model
â”‚   â””â”€â”€ ocr
â”‚       â”œâ”€â”€ det.onnx
â”‚       â”œâ”€â”€ keys.txt
â”‚       â””â”€â”€ rec.onnx
â””â”€â”€ pipeline
    â”œâ”€â”€ my_pipeline_1.json
    â””â”€â”€ my_pipeline_2.json
```

å…¶ä¸­ä»¥ `my_` å¼€å¤´çš„æ–‡ä»¶/æ–‡ä»¶å¤¹å‡å¯è‡ªè¡Œä¿®æ”¹åç§°ï¼Œå…¶ä»–çš„åˆ™ä¸ºå›ºå®šæ–‡ä»¶åï¼Œä¸å¯ä¿®æ”¹ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»ï¼š

### Pipeline JSON æ–‡ä»¶

`my_resource/pipeline` ä¸­çš„æ–‡ä»¶ï¼ŒåŒ…å«ä¸»è¦çš„è„šæœ¬æ‰§è¡Œé€»è¾‘ï¼Œä¼šé€’å½’è¯»å–ç›®å½•ä¸­æ‰€æœ‰çš„ json æ ¼å¼æ–‡ä»¶ã€‚

å¯å‚è€ƒ [ä»»åŠ¡æµæ°´çº¿åè®®](3.1-ä»»åŠ¡æµæ°´çº¿åè®®.md) è¿›è¡Œç¼–å†™ï¼Œä¸€ä¸ªç®€å•çš„ [demo](https://github.com/MaaXYZ/MaaFramework/blob/main/sample/resource/pipeline/sample.json)

å°å·¥å…·ï¼š

- [JSON Schema](https://github.com/MaaXYZ/MaaFramework/blob/main/tools/pipeline.schema.json)
- [VSCode æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=nekosu.maa-support)
  - åŸºäº `interface.json` é…ç½®èµ„æº
  - æ”¯æŒè·³è½¬åˆ°ä»»åŠ¡å®šä¹‰ã€æŸ¥æ‰¾ä»»åŠ¡å¼•ç”¨ã€é‡å‘½åä»»åŠ¡ã€è¡¥å…¨ä»»åŠ¡ã€ç‚¹å‡»æ‰§è¡Œä»»åŠ¡
  - æ”¯æŒæŒ‰ç…§ MaaPiCli æ¨¡å¼æ‰§è¡Œ
  - æ”¯æŒè¿æ¥åæˆªå›¾å¹¶è£å‰ªå›¾ç‰‡

### å›¾ç‰‡æ–‡ä»¶

`my_resource/image` ä¸­çš„æ–‡ä»¶ï¼Œä¸»è¦ä¸º pipeline æ‰€ç”¨åˆ°çš„æ¨¡æ¿åŒ¹é…å›¾ç‰‡ã€ç‰¹å¾æ£€æµ‹å›¾ç‰‡ç­‰ï¼Œä¼šæŒ‰ç…§ pipeline ä¸­è®¾å®šçš„ `template` ç­‰å­—æ®µè¯»å–å¯¹åº”çš„æ–‡ä»¶ã€‚

æ‰€ä½¿ç”¨çš„å›¾ç‰‡éœ€è¦æ˜¯æ— æŸåŸå›¾ç¼©æ”¾åˆ° 720p åçš„è£å‰ªã€‚è‹¥ä½¿ç”¨å®‰å“æ¨¡æ‹Ÿå™¨ï¼Œè¯·ä½¿ç”¨æ¨¡æ‹Ÿå™¨è‡ªå¸¦çš„æˆªå›¾åŠŸèƒ½ï¼ï¼ˆä¸å¯ä»¥ç›´æ¥å¯¹æ¨¡æ‹Ÿå™¨çª—å£è¿›è¡Œæˆªå›¾ï¼‰

**é™¤éä½ å®Œå…¨æ¸…æ¥š MaaFramework åœ¨åšä»€ä¹ˆï¼Œå¦åˆ™è¯·ä½¿ç”¨ä¸‹é¢çš„æˆªå›¾å·¥å…·æ¥è·å–å›¾ç‰‡ã€‚**

- [VSCode æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=nekosu.maa-support)
- [MFA å°å·¥å…·](https://github.com/SweetSmellFox/MFATools)
- [å›¾ç‰‡è£å‰ªåŠ ROI è·å–å·¥å…·](https://github.com/MaaXYZ/MaaFramework/tree/main/tools/ImageCropper)

### æ–‡å­—è¯†åˆ«æ¨¡å‹æ–‡ä»¶

*â­è‹¥æ‚¨ä½¿ç”¨é¡¹ç›®æ¨¡æ¿ï¼Œç›´æ¥æŒ‰ç…§å…¶æ–‡æ¡£ï¼Œè¿è¡Œ `configure.py` å³å¯è‡ªåŠ¨éƒ¨ç½²æ¨¡å‹æ–‡ä»¶ã€‚*

`my_resource/model/ocr` ä¸­çš„æ–‡ä»¶ï¼Œä¸º [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR) è½¬ ONNX åçš„æ¨¡å‹æ–‡ä»¶ã€‚

å¯ä½¿ç”¨æˆ‘ä»¬çš„é¢„è½¬æ¢æ–‡ä»¶ï¼š[MaaCommonAssets](https://github.com/MaaXYZ/MaaCommonAssets/tree/main/OCR)ï¼Œé€‰æ‹©éœ€è¦çš„è¯­ç§ï¼ŒæŒ‰ç…§ [ä¸Šè¿°](#å‡†å¤‡èµ„æºæ–‡ä»¶) ç›®å½•ç»“æ„å­˜æ”¾å³å¯ã€‚

è‹¥æœ‰éœ€è¦ä¹Ÿå¯ä»¥è‡ªè¡Œå¯¹ PaddleOCR çš„å®˜æ–¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œ fine-tuning ï¼ˆè¯·è‡ªè¡Œå‚è€ƒ [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR) å®˜æ–¹æ–‡æ¡£ï¼‰ï¼Œå¹¶è½¬æ¢æˆ ONNX æ–‡ä»¶ä½¿ç”¨ï¼Œè½¬æ¢å‘½ä»¤å¯å‚è€ƒ [è¿™é‡Œ](https://github.com/MaaXYZ/MaaCommonAssets/tree/main/OCR#command)

## è°ƒè¯•

- ä½¿ç”¨ [MaaDebugger](https://github.com/MaaXYZ/MaaDebugger)ã€‚
- ä½¿ç”¨ [VSCode æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=nekosu.maa-support)ã€‚
- ä½¿ç”¨ MaaPiCli ï¼Œä¼šåœ¨åŒç›®å½•ä¸‹ç”Ÿæˆ `config/maa_option.json` æ–‡ä»¶ï¼Œå…¶ä¸­ï¼š

  - `logging`: ä¿å­˜æ—¥å¿—ï¼Œä¼šç”Ÿæˆ `debug/maa.log`ã€‚é»˜è®¤ true ã€‚
  - `recording`: ä¿å­˜å½•åƒåŠŸèƒ½ï¼Œä¼šä¿å­˜è¿è¡ŒæœŸé—´æ‰€æœ‰çš„æˆªå›¾åŠæ“ä½œæ•°æ®ï¼Œå¯ä½¿ç”¨ `DbgController` è¿›è¡Œå¤ç°è°ƒè¯•ã€‚é»˜è®¤ false ã€‚
  - `save_draw`: ä¿å­˜å›¾åƒè¯†åˆ«å¯è§†åŒ–ç»“æœï¼Œä¼šä¿å­˜è¿è¡ŒæœŸé—´æ‰€æœ‰å›¾åƒè¯†åˆ«å¯è§†åŒ–ç»“æœç»˜åˆ¶å›¾ã€‚é»˜è®¤ false ã€‚
  - `show_hit_draw`: æ˜¾ç¤ºèŠ‚ç‚¹å‘½ä¸­å¼¹çª—ï¼Œæ¯æ¬¡è¯†åˆ«æˆåŠŸä¼šå¼¹çª—æ˜¾ç¤ºè¯†åˆ«ç»“æœã€‚é»˜è®¤ false ã€‚
  - `stdout_level`: æ§åˆ¶å°æ˜¾ç¤ºæ—¥å¿—ç­‰çº§ã€‚é»˜è®¤ 2ï¼ˆErrorï¼‰ï¼Œå¯è®¾ä¸º 0 å…³é—­å…¨éƒ¨æ§åˆ¶å°æ—¥å¿—ï¼Œæˆ–è®¾ä¸º 7 æ‰“å¼€å…¨éƒ¨æ§åˆ¶å°æ—¥å¿—ã€‚

- è‹¥è‡ªè¡Œé›†æˆï¼Œå¯é€šè¿‡ `Toolkit.init_option` / `MaaToolkitConfigInitOption` æ¥å£å¼€å¯è°ƒè¯•é€‰é¡¹ã€‚ç”Ÿæˆçš„ json æ–‡ä»¶åŒä¸Šã€‚

## è¿è¡Œ

ä½¿ç”¨ é€šç”¨ CLIï¼ˆMaaPiCliï¼‰ã€ç¬¬ä¸‰æ–¹é€šç”¨ GUIï¼ˆä¾‹å¦‚ MFAWPF ç­‰ï¼‰æˆ–è€… è‡ªè¡Œç¼–å†™é›†æˆä»£ç 

### ä½¿ç”¨ MaaPiCli

*â­è‹¥æ‚¨ä½¿ç”¨é¡¹ç›®æ¨¡æ¿ï¼Œç›´æ¥æŒ‰ç…§å…¶æ–‡æ¡£ï¼Œè¿è¡Œ `install.py` åå³å¯è‡ªåŠ¨æ‰“åŒ…ç›¸å…³æ–‡ä»¶*

ä½¿ç”¨ Release åŒ… bin æ–‡ä»¶å¤¹ä¸­çš„ MaaPiCli ï¼Œå¹¶ç¼–å†™ `interface.json` ç½®äºåŒç›®å½•ä¸‹ï¼Œå³å¯ä½¿ç”¨

- [interface.json æ–‡æ¡£](3.2-ProjectInterfaceåè®®.md)
- [Sample](https://github.com/MaaXYZ/MaaFramework/blob/main/sample/interface.json)

å®è·µ:

- [M9A](https://github.com/MaaXYZ/M9A/tree/main/assets/interface.json)

### è‡ªè¡Œç¼–å†™é›†æˆä»£ç 

è¯·å‚è€ƒ [é›†æˆæ–‡æ¡£](2.1-é›†æˆæ–‡æ¡£.md)
