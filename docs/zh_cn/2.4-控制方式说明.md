# 2.4 控制方式说明

本文档详细说明 MaaFramework 中 Screencap（截图）和 Input（控制）的各种方式及其配置。

> [!TIP]
>
> - 对于 API ，screencap/input 使用 `int` 类型（按位或组合）；对于 [ProjectInterface V2](3.3-ProjectInterfaceV2协议.md)，使用 `string` 类型（直接使用名称）。
> - [ProjectInterface V2](3.3-ProjectInterfaceV2协议.md) 仅支持配置 Win32 控制器的 screencap/mouse/keyboard 方式。Adb 控制器的 screencap/input 使用 `MaaToolkitAdbDeviceFind` 自动检测和选择最优方式，无需手动配置。

## Adb

### Adb Input

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L227-L240)

将下面选择的方式 **按位或** 合并为一个值提供。MaaFramework 将会按照固定优先级顺序尝试所有提供的方式，选择首个可用方式。

默认尝试除 EmulatorExtras 外所有方式。

> 优先级: EmulatorExtras > Maatouch > MinitouchAndAdbKey > AdbShell

| 名称 | API 值 | 速度 | 兼容性 | 说明 |
| --- | --- | --- | --- | --- |
| AdbShell | `1` | 慢 | 高 |  |
| MinitouchAndAdbKey | `2` | 快 | 中 | 按键仍使用 AdbShell |
| Maatouch | `4` | 快 | 中 |  |
| EmulatorExtras | `8` | 快 | 低 | 仅支持模拟器：MuMu 12 |

### Adb Screencap

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L208-L225)

将下面选择的方式 **按位或** 合并为一个值提供。MaaFramework 将会尝试所有提供的方式，选择最快的可用方式。

默认尝试除 `RawByNetcat`，`MinicapDirect`，`MinicapStream` 外所有方式。

`MinicapDirect` 和 `MinicapStream` 由于会编码为 jpg，为有损编码，将显著降低模板匹配的效果，不建议使用。

| 名称 | API 值 | 速度 | 兼容性 | 编码 | 说明 |
| --- | --- | --- | --- | --- | --- |
| EncodeToFileAndPull | `1` | 慢 | 高 | 无损 |  |
| Encode | `2` | 慢 | 高 | 无损 |  |
| RawWithGzip | `4` | 中 | 高 | 无损 |  |
| RawByNetcat | `8` | 快 | 低 | 无损 |  |
| MinicapDirect | `16` | 快 | 低 | 有损 |  |
| MinicapStream | `32` | 极快 | 低 | 有损 |  |
| EmulatorExtras | `64` | 极快 | 低 | 无损 | 仅支持模拟器：MuMu 12、雷电 9 |

## Win32

### Win32 Input

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L252-L259)

选择下面的值提供。

无默认值。Client 可以选择一个作为默认值。

Win32 下不同程序处理输入的方法不同，不存在一个通用方式。

| 名称 | API 值 | 兼容性 | 需管理员权限 | 抢占鼠标 | 支持后台 | 说明 |
| --- | --- | --- | --- | --- | --- | --- |
| Seize | `1` | 高 | 否 | 是 | 否 |  |
| SendMessage | `2` | 中 | 可能 | 否 | 是 |  |
| PostMessage | `4` | 中 | 可能 | 否 | 是 |  |
| LegacyEvent | `8` | 低 | 否 | 是 | 否 |  |
| PostThreadMessage | `16` | 低 | 可能 | 否 | 是 |  |
| SendMessageWithCursorPos | `32` | 中 | 可能 | 短暂 | 是 | 专为原神等检测实际鼠标位置的游戏设计 |
| PostMessageWithCursorPos | `64` | 中 | 可能 | 短暂 | 是 | 专为原神等检测实际鼠标位置的游戏设计 |
| Gamepad | `128` | 低 | 否 | 否 | 是 | 模拟虚拟 Xbox 360 手柄，需安装 [ViGEmBus](https://github.com/nefarius/ViGEmBus/releases) 驱动 |

> [!NOTE]
>
> - 管理员权限主要取决于目标程序的权限级别，若目标程序为管理员权限，则需以管理员权限运行以保证兼容性。
> - `WithCursorPos` 系列方式会短暂移动光标到目标位置，发送完消息后会将光标移回原位置，因此会“短暂”抢占鼠标，但不会阻止用户操作。

### Win32 Screencap

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L242-L250)

选择下面的值提供。

无默认值。Client 可以选择一个作为默认值。

Win32 下不同程序处理绘制的方法不同，不存在一个通用方式。

| 名称 | API 值 | 速度 | 兼容性 | 需管理员权限 | 支持后台 | 说明 |
| --- | --- | --- | --- | --- | --- | --- |
| GDI | `1` | 快 | 中 | 否 | 否 |  |
| FramePool | `2` | 极快 | 中 | 否 | 是 | Windows 10 1903+ 可用 |
| DXGI_DesktopDup | `4` | 极快 | 低 | 否 | 否 | 桌面复制（全屏输出复制） |
| DXGI_DesktopDup_Window | `8` | 极快 | 低 | 否 | 否 | 桌面复制后裁剪 |
| PrintWindow | `16` | 中 | 中 | 否 | 是 |  |
| ScreenDC | `32` | 快 | 高 | 否 | 否 |  |

> [!NOTE]
>
> Windows 在窗口最小化后会停止绘制该窗口内容，所有截图方式均无法获取有效内容，请避免窗口最小化。

## PlayCover (macOS)

PlayCover 控制器用于在 macOS 上控制通过 [fork版PlayCover](https://github.com/hguandl/PlayCover/releases) 运行的 iOS 应用程序。

### 使用方式

```cpp
// C API
auto controller = MaaPlayCoverControllerCreate("127.0.0.1:1717", "com.example.app");
```

```python
# Python
from maa.controller import PlayCoverController
controller = PlayCoverController("127.0.0.1:1717", "com.example.app")
```

```typescript
// NodeJS
const controller = new maa.PlayCoverController("127.0.0.1:1717", "com.example.app")
```

### 参数说明

| 参数 | 说明 |
| --- | --- |
| address | PlayTools 服务监听地址，格式为 `host:port`，如 `127.0.0.1:1717` |
| uuid | 目标应用的 Bundle Identifier，如 `com.hypergryph.arknights` |

### 支持的功能

| 功能 | 支持 | 说明 |
| --- | --- | --- |
| 截图 (screencap) | ✓ | 通过 PlayTools 协议获取 RGBA 原始数据 |
| 点击 (click) | ✓ | 使用 touch_down + touch_up 实现 |
| 滑动 (swipe) | ✓ | 使用三次样条插值实现平滑轨迹 |
| 触摸 (touch_down/move/up) | ✓ | 仅支持单点触摸 (contact=0) |
| 停止应用 (stop_app) | ✓ | 发送终止命令 |
| 启动应用 (start_app) | ✗ | PlayCover 不支持通过协议启动应用 |
| 按键 (click_key/key_down/key_up) | ✗ | PlayTools 协议不支持 |
| 文本输入 (input_text) | ✗ | PlayTools 协议不支持 |
| 滚动 (scroll) | ✗ | PlayTools 协议不支持 |

### 前置要求

1. 在 macOS 上安装 [fork版PlayCover](https://github.com/hguandl/PlayCover/releases)
2. 目标 iOS 应用需要在playcover中启用 MaaTools 功能

> [!NOTE]
>
> PlayCover 控制器的特性标志为 `MaaControllerFeature_UseMouseDownAndUpInsteadOfClick`，表示框架会使用 touch_down + touch_up 代替 click 操作。
