# 控制方式说明

本文档详细说明 MaaFramework 中 Input（控制）和 Screencap（截图）的各种方式及其配置。

> [!TIP]
>
> - 对于 API ，input/screencap 使用 `int` 类型（按位或组合）；对于 [ProjectInterface V2](3.3-ProjectInterfaceV2协议.md)，使用 `string` 类型（直接使用名称）。
> - [ProjectInterface V2](3.3-ProjectInterfaceV2协议.md) 仅支持配置 Win32 控制器的 input/screencap 方式。Adb 控制器的 input/screencap 使用 `MaaToolkitAdbDeviceFind` 自动检测和选择最优方式，无需手动配置。

## Adb

### Adb Input

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L227-L240)

将下面选择的方式 **按位或** 合并为一个值提供。MaaFramework 将会按照固定优先级顺序尝试所有提供的方式，选择首个可用方式。

默认尝试除 EmulatorExtras 外所有方式。

> 优先级: EmulatorExtras > Maatouch > MinitouchAndAdbKey > AdbShell

| 名称 | 值 | 说明 |
| --- | --- | --- |
| AdbShell | `1` | 使用 adb 进程进行控制。 |
| MinitouchAndAdbKey | `2` | 使用 adb 进程进行按键控制，使用 minitouch 工具进行触摸控制。 |
| Maatouch | `4` | 使用 maatouch 工具控制。 |
| EmulatorExtras | `8` | 使用模拟器专用工具进行控制。目前支持的模拟器：MuMu 12 |

### Adb Screencap

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L208-L225)

将下面选择的方式 **按位或** 合并为一个值提供。MaaFramework 将会尝试所有提供的方式，选择最快的可用方式。

默认尝试除 `RawByNetcat`，`MinicapDirect`，`MinicapStream` 外所有方式。

`MinicapDirect` 和 `MinicapStream` 由于会编码为 jpg，为有损编码，将显著降低模板匹配的效果，不建议使用。

| 名称 | 值 | 说明 |
| --- | --- | --- |
| EncodeToFileAndPull | `1` | 通过内置 screencap 进程截图，编码为 png 输出到文件，通过 adb 进程拉取文件，读取文件。 |
| Encode | `2` | 通过内置 screencap 进程截图，编码为 png，通过 adb 进程管道传输。 |
| RawWithGzip | `4` | 通过内置 screencap 进程截图，通过 gzip 压缩，通过 adb 进程管道传输。 |
| RawByNetcat | `8` | 通过内置 screencap 进程截图，通过 nc 进程网络传输。 |
| MinicapDirect | `16` | 通过 minicap 工具截图和编码为 jpg，通过 adb 进程管道传输。 |
| MinicapStream | `32` | 通过 minicap 工具流式截图和编码为 jpg，通过 adb 进程管道传输。 |
| EmulatorExtras | `64` | 使用模拟器专用工具进行截图。目前支持的模拟器：MuMu 12、雷电 9 |

## Android

### Android Input

> 参考 `MaaAndroidInputMethod` 定义。

| 名称 | 值 | 说明 |
| --- | --- | --- |
| Accessibility | `1` | 通过辅助功能进行控制，包括 `dispatchGesture` 点击/滑动/滚动、全局按键（返回/主页/多任务）、以及对焦点输入框执行 `ACTION_SET_TEXT`。 |

### Android Screencap

> 参考 `MaaAndroidScreencapMethod` 定义。

将下面选择的方式 **按位或** 合并为一个值提供。框架会按可用性选择，优先使用 MediaProjection（更快更稳定），其次使用 AccessibilityScreenshot。

| 名称 | 值 | 说明 |
| --- | --- | --- |
| AccessibilityScreenshot | `1` | API 33+ 辅助功能 `takeScreenshot`。无需额外权限，但需要 Android 13 及以上。 |
| MediaProjection | `2` | MediaProjection 虚拟显示截图，需要用户授权录屏。速度更快，兼容性更好。 |

## Win32

### Win32 Input

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L252-L259)

选择下面的值提供。

无默认值。Client 可以选择一个作为默认值。

Win32 下不同程序处理输入的方法不同，不存在一个通用方式。

| 名称 | 值 | 说明 |
| --- | --- | --- |
| Seize | `1` | 抢占式控制。通过 `SendInput`/前台聚焦进行输入；会抢占焦点、移动系统光标、阻塞用户输入，不能后台控制。 |
| SendMessage | `2` | 直接向窗口发送 `WM_*` 消息；可后台控制（窗口可失焦），但受 UIPI/权限限制：若目标为高完整性进程（管理员运行），需要以相同或更高权限运行。 |
| PostMessage | `4` | 与 `SendMessage` 类似但异步投递；可后台控制，同样受 UIPI/权限限制。 |
| LegacyEvent | `8` | 旧版 `mouse_event`/`keybd_event` 接口；依赖前台与系统光标、阻塞用户输入，实测兼容性一般，不能后台控制。 |
| PostThreadMessage | `16` | 向窗口所属线程消息队列投递消息；可后台控制，但要求目标线程有消息循环，同样受 UIPI/权限限制。 |
| SendMessageWithCursorPos | `32` | 结合 `SendMessage` 与实际光标移动；通过 `SetCursorPos` 移动系统光标到目标位置后发送同步消息。专为原神等检测实际鼠标位置的游戏设计，可后台控制，同样受 UIPI/权限限制。 |
| PostMessageWithCursorPos | `64` | 结合 `PostMessage` 与实际光标移动；通过 `SetCursorPos` 移动系统光标到目标位置后发送异步消息。专为原神等检测实际鼠标位置的游戏设计，可后台控制，同样受 UIPI/权限限制。 |

### Win32 Screencap

> 参考 [MaaDef.h](https://github.com/MaaXYZ/MaaFramework/blob/main/include/MaaFramework/MaaDef.h#L242-L250)

选择下面的值提供。

无默认值。Client 可以选择一个作为默认值。

Win32 下不同程序处理绘制的方法不同，不存在一个通用方式。

| 名称 | 值 | 说明 |
| --- | --- | --- |
| GDI | `1` | 基于窗口 `HDC`/`BitBlt` 的抓取；对部分程序/遮挡情形可能受 DWM/渲染路径影响。 |
| FramePool | `2` | Windows Graphics Capture（`Direct3D11CaptureFramePool`）；对被遮挡窗口通常可后台抓取，Windows 10 1903+ 可用。 |
| DXGI_DesktopDup | `4` | 桌面复制（全屏输出复制）；不支持后台抓取窗口（会包含遮挡内容/仅桌面帧）。 |
| DXGI_DesktopDup_Window | `8` | 桌面复制后裁剪到窗口客户区；与 `DXGI_DesktopDup` 一致，遮挡会影响结果。 |
| PrintWindow | `16` | 使用 `PrintWindow` 抓取；支持非最小化后台窗口，部分程序/图层窗口可能不兼容。 |
| ScreenDC | `32` | 从屏幕 DC 依据窗口客户区矩形裁剪抓取；完全受遮挡影响，不支持后台。 |
